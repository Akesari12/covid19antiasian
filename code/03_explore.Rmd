---
title: "03_preprocess_data"
author: "Jae Yeon Kim"
date: "7/2/2020"
output: html_document
---

# Import packages and files 

## Packages

```{r}

pacman::p_load(tidyverse, # for tidyverse 
               ggpubr, # for arranging ggplots   
               ggthemes, # for fancy ggplot themes
               here, # for reproducibility 
               countrycode, # to convert country code <-> country name 
               maps, # for US city data
               openintro, # for revert state name abbreviations to their original forms 
               stringr, # for easy regular expression
               lubridate, # for easy time var manipulation
               forcats, # reverse factor order 
               patchwork, # for easy ggarrange
               ggsci) # for pubs 

# for publication-friendly theme 
theme_set(theme_pubr())

# custom functions
source(here("functions", "stacked_bar_plot.R"))

```

## Files 

- 5,050,042 obs 

```{r}

parsed <- readRDS(here("processed_data", "parsed.rds"))

sum(is.na(parsed))/nrow(parsed)
```

# Wrangle 

## Filter

- Filtered if location field is empty or NA: 3,734,756 obs (73% of the original data)
- I did not use country_code field as it is mostly filled with NAs (97%).

```{r}

filtered <- parsed %>%
    filter(!(location == "" | is.na(location)))

```

## Select 

```{r}

# Select columns 
selected <- filtered %>% 
    select(country_code, location, created_at, full_text) 

```

## Mutate 

`maps::us.cities` database includes the names of the US cities whose population sizes are larger than 40,000. 

```{r}

# Identify US location 

us_cities <- maps::us.cities$name %>% str_replace_all(" [[:alpha:]]*$", "") %>% unique() %>% tolower()

us_states_abb <- maps::us.cities$name %>% stringr::word(-1) %>% unique() %>% tolower()

us_states <- maps::us.cities$name %>% stringr::word(-1) %>% unique() %>% abbr2state() %>% tolower()

us_country <- c("United States", "USA", "US") %>% tolower()

us_location_list <- c(us_cities, us_states_abb, us_states, us_country) %>% paste(collapse = "|")

selected <- selected %>% 
    mutate(US = str_detect(location %>% towlower(), c(us_cities, us_states_abb, us_states, us_country) %>% paste(collapse = "|")) %>% as.numeric())

# Lower case 
selected$full_text <- str_to_lower(selected$full_text)

# Create new columns 
selected <- selected %>%
    mutate(full_text = str_to_lower(full_text),
           wuhan = as.numeric(str_detect(full_text, "wuhan")),
           asian = as.numeric(str_detect(full_text, "asia|asian")),
           chinese = as.numeric(str_detect(full_text, "china|chinese")),
           country_name = countrycode(country_code, "iso2c", "country.name")
    )

# Reformat date-time 
selected$date <- as.POSIXct(selected$created_at, 
                            tz = "UTC",
                            format = "%a %b %d %H:%M:%S %z %Y") %>% #
                 word(1) # Only year month date 

# Only month 
# selected$month <- months(as.Date(selected$date)) %>%
#    fct_relevel("January", "February", "March", "April", "May", # "June") # Relevel factor order 

# Remove except selected
# rm(list = setdiff(ls(), "selected"))

```

# Explore 

## Trends in the top 10 countries (by count)

```{r}

# Create a list 
sorted <- selected %>% 
    group_by(country_name) %>%
    count(sort = TRUE) 

# Subquery, group by, then visualize 
selected %>%
    filter(country_name == intersect(country_name, sorted$country_name[1:9])) %>%
    group_by(country_name, date) %>%
    count() %>%
    ggplot(aes(x = as.Date(date), y = n, group = 1)) +
        geom_line() +
        facet_wrap(~country_name, ncol = 3) +
        labs(x = "Date",
             y = "Count",
             title = "The Count of Tweets on COVID-19",
             subtitle = "These nine countries were selected by the number of tweets.")

ggsave(here("outputs", "top9_countries.png"), height = 7)

```

## Trends in the US and UK (with a focus on concerned categories)

```{r}

p1 <- stacked_bar_plot(selected, wuhan) +
        labs(x = "Date",
             y = "Proportion",
             fill = "Wuhan",
             title = "Wuhan")

p2 <- stacked_bar_plot(selected, chinese) +
        labs(x = "Date",
             y = "Proportion",
             fill = "Chinese",
             title = "Chinese")

p3 <- stacked_bar_plot(selected, asian) +
        labs(x = "Date",
             y = "Proportion",
             fill = "Asian",
             title = "Asian")

p1 / p2 / p3
ggsave(here("outputs", "stacked_bar_plots.png"),
       height = 10)

```

# Export 

```{r}

df <- subset(selected, country_code == "US") %>%
    select("full_text", "wuhan", "asian", "chinese",
           "date")

write_csv(df, here("processed_data", "text_ready.csv"))

```

